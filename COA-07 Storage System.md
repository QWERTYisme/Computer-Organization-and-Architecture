### 存储系统的层次结构

#### 存储系统的基本要素

- 功能分类
  - 主存（内存）：半导体存储器，存放当前正在执行的程序和数据。
  - 辅存（外存）：磁盘、磁带、光盘，存放当前不在运行的大量程序和数据。

- 访问方式
  - 随机存储器：可随机访问任一单元。
  - 串行存储器：访问指定信息所需时间与信息所在位置有关。
- 关键问题
  - 现实问题：存储系统是整个计算机系统的性能瓶颈。
  - 目标：解决对存储器要求容量大、速度快、成本低三者之间的矛盾。
  - 解决方案：为解决三者间的矛盾，**目前通常采用层次结构存储系统**。



#### 主要技术指标

- 存储容量（S）：可存储的二进制位数，单位常为字节（B）。
- 存取速度（B）：常用存取时间、存取周期表示。
  - 存取时间（TA）：指存储器从收到命令到完成操作所需的时间。
  - 存取周期（TM）：指连续访问存储器的最小时间间隔，TM=TA+T恢复。
- 传输速度：常用存储器带宽（BM）表示。
  - 定义：指存储器的最大数据传输率，单位常为Mbps。
  - 公式：BM=W/TM，W为数据宽度（数据引脚位数）。

> 思考：某1K×8位SRAM芯片的存储周期 为100ns，该芯片的带宽是多少？



#### 层次结构的引入

现实问题：大容量 vs 高速度、高速度 vs 低价格。

程序访问的局部性原理：程序运行时，访问指令和数据所呈现出的相对簇聚的现象。

- 时间局部性：最近访问过的信息，将会被再次访问。
- 空间局部性：最近访问过信息的相邻信息，将会被访问。

解决方案：层次结构存储系统。

**快速存储器+慢速存储器**

- 快速存储器→近期常用数据、容量小
- 慢速存储器→近期为用数据、容量大



#### 层次结构的组成

基本组成：多种存储器{M1, M2, …, Mn}级联（上下级关系）。

参数要求： SM1<<SM2<<…<<SMn，TM1<<TM2<<…<<TMn 。

内容要求：上级存储器中的信息为下级存储器中信息的**副本**。

传递要求：各级存储器之间的信息传递是**透明**的，即存储系统外部不可见、可见的是存取周期不固定。



#### 多级存储体系结构的实现和比较

从寄存器到L1、L2、L3缓存，再到内存，固态硬盘、机械硬盘，到网络云存储空间，**访问速度越来越慢，每位的价格越来越便宜，存储容量越来越大**



#### 常见的层次结构

##### 以“主存”为中心，常为“Cache-主存-辅存”三层结构。

- **高速缓冲存储器（Cache）**

  用途：高速存取指令和数据，可与CPU速度
  匹配

  特点：存取速度快 存储容量小

- **主存储器（主存）**

  用途：存放计算机运行期间的大量程序和数
  据

  特点：存取速度较快 存取容量大

- **辅助存储器（辅存）**

  用途：存放系统程序和大型数据文件及数据
  库

  特点：存储容量大 位成本低

##### Cache-主存层次

目标：解决**主存速度**问题（Cache的速度，主存的容量）。

Cache引入：解决CPU的主存的速度差距，提高整机的运算速度。

Cache特点：存储速度快，容量小，存储控制和管理由硬件实现。

数据传递

- CPU <==> Cache：以字为单位。
- Cache <==> 主存：以块为单位，一个块由若干个字组成，是定长的。

实现：Cache中，每个块外加有一个**标记**，指明它是主存的哪一块的**副本**。

问题：**如何实现Cache和主存的高效映射？**

##### 主存-辅存层次

目标：解决主存容量问题（主存的速度，辅存的容量）

- 主存：半导体存储器组成。

  特点：速度快，但容量受限、单位成本高、断电易丢失。

- 辅存：磁盘、光盘。

  特点：容量大，单位成本低，信息长久保存，但存取速度慢。

数据传递

- 辅存只与主存进行数据交换。
- 主存 <==> 辅存：以段、页或两者结合为单位。

实现：虚拟存储器，实现容量扩展和进程管理等。

问题：**如何实现虚拟存储器和主存的高效映射？**

### 高速缓冲存储器（Cache）

#### Cache的工作原理

组成：小容量的SRAM存储器和高速缓存控制器组成。

位置：Cache存储器介于CPU和主存之间。

性能指标

- 命中率：H ＝ Nc /(Nc＋Nm) ＝ 命中Cache次数/访存总次数。

- 平均访问时间：指Cache-主存层次完成访存操作平均所用时间。

  TA ＝ H·Tc＋(1－H)(Tc＋Tm) ＝ Tc＋(1－H)Tm ＝ T命中＋(1－H)T缺失



#### Cache-主存的层次管理要求

目标：**减小TA**， TA＝Tc＋(1－H)Tm 。

方法

- 提高H：利用程序**访问局部性** -> **相邻信息**放在Cache中。
- 减小Tm：利用**突发传输**模式

Cache-主存的信息交换单位：块（Block，又称字块）

- 块大小：n个存储字（即主存字[主存单元中的信息]，n为常数）。
- 块大小的确定：固定值，H较高时的n，通常为8个机器字长。



#### Cache存储空间的编址

单位：采用主存的编址单位，即**主存字**。（Cache是主存的缓冲器）

Cache-主存的信息交换管理

- 归一化：主存和Cache的存储空间，都**划分**成多个大小为**块**的区域。
- Cache每行需设置**有效位（V）**和**标记（Tag）**表示本行**是/否空闲**和**数据来自的主存块**。



#### Cache存储空间的组织

结构：Cache是行的数组，每行包含缓存块信息、管理信息。

容量：Cache数据区的容量称为Cache容量；Cache数据区、管理区容量之和称为Cache总容量。

缓存块：大小、编址单位都与主存块相同。

- 块内：地址位数＝log2(块大小÷主存字大小) 。
- 块间：一个块称为Cache的一行 -> Cache行数＝Cache容量÷块大小。

Cache命中：是否命中，通过比较**有效位**和**标记**来实现。



#### Cache工作的基本过程

完整访问过程：①地址**变换**，②**访问**Cache，③数据**写回**主存。

相关技术：映射规则、替换算法、写策略。

实现要求：**全部由硬件完成**（高速目标的要求）。



#### Cache的读操作

基本过程

- 命中：如果数据在Cache中(命中Hit)，就直接对Cache进行读操作，与主存无关。
- 不命中：如果Cache不命中(Miss)，则仍需访问主存，并把该块信息一次从主存调入Cache。

相关技术：替换算法。

- 所解决的问题：从主存读出新的字块调入Cache存储器时，如果遇到Cache存储器中相应的位置 已被其他字块占有，那么就必须去掉一个旧的字块，让位于一个新的字块。
- 替换规则：替换应该遵循一定的规则，最好能使被替换的字块是**下一段时间内估计最少使用的**。 这些规则称为替换策略或替换算法，由替换部件加以实现。



#### Cache的写操作与更新策略

基本过程：更新**Cache数据**和**主存数据**，后者的更新时机可选。

相关技术：写策略。

- 写通法（全写法、直达法）：命中时同时写Cache和主存，未命中时直接写主存。
  - 优点：无需设置修改位及判断逻辑。
  - 缺点：降低了Cache的功效。
- 写回法：命中时只写Cache而不立即写主存，只有当此行被换出时才写回主存。
  - 优点：减少了访存次数。
  - 缺点：存在不一致的隐患，需设置修改位及判断逻辑。



#### Cache的组织和结构

基本结构：存储体、地址映射机构、替换机构、读写机构。

访问过程的组织：见ppt第20页

地址映射机构：由有效位（V）和标记（Tag）、比较器组成。

- 映射机制：确定Tag位数和每次的查找范围（候选行）。

  组织：主存块号＝<标记, 索引>（标记对应Tag位数，索引对应查找范围）

- 查找机构：判断是否命中，获得目标行地址或空闲地址

  实现：候选行的Tag＝主存地址中的标记 **且** 有效位＝1？

替换机构：由状态位、状态更新及行选择部件等组成。

- 更新机制：**更新**候选行的状态（取决于**替换算法**）。
- 选择机构：在候选行**选择牺牲行**，**腾空**行中数据。

读写机构：存储器访问部件。

- 功能：读出主存块、块/字写回主存（取决于**写策略**）。



#### Cache的地址映射

任务：确定一个主存块可放到Cache的**哪些行**。

性能指标：地址变换的**速度与成本**，块调入时的**冲突率**。

分类：不同的映射规则。

- 直接映射（Direct Mapping）：主存块i只可以放到Cache的**某个行**j中。
- 全相联映射（Fully Associate Mapping）：主存块i可以放到Cache的**任意行**j中。
- 组相联映射（Set Associate Mapping）：将Cache的行分组，每个组有n个行；主存块i可以放 到Cache**某个组**j的**任意行**中。



#### 直接映射

映射规则：主存块i只可放到Cache的某个行j中，j＝i mod G。

- 其中，j是Cache的行（块）号，i是主存的块号，G为Cache的行数。

实现：把主存分成若干个区，每个区与Cache大小相同，区内按照Cache进行同样的分块。

- 主存地址：<区号，区内块号，块内地址>。
- Cache地址：<行（块）号，块内地址>。

标记选定：索引＝区内块号，**标记＝主存块号－索引＝区号**。

本质：多对一的映射关系，一个主存块只能映射到Cache的一个特定块位置上去。

地址变换：Cache中的候选行只有1行（索引值＝行号）。

- 命中条件：主存地址中的**区号**＝候选行的**标记Tag**，且有效位V＝1时。
- 变换结果：Cache地址＝<命中行号,**块内地址**>。

特征：地址变换速度**最快**、成本**最低**，但块调入时冲突率**最高**。

优点：地址变换简单、速度快，可直接由主存地址提取Cache地址，确定所需字块是否已在Cache中。

缺点：不够灵活，主存的多个字块只能对应唯一的Cache字块。因此，即使Cache别的地址空闲也不 能占用，使得Cache存储空间得不到充分利用，降低了命中率。



#### 全相联映射

映射规则：主存块i可以放到Cache的**任意行**j中，j∈{0,1,…,G-1}。

实现：除块内地址外，主存地址与Cache地址无必然联系。

- 主存地址：<主存块号，块内地址>。
- Cache地址：<行（块）号，块内地址>。

标记选定：没有索引，标记＝主存块号(m位)。

地址变换：候选行有G个(Cache所有行)。

- 命中条件：地址中的主存块号与候选行的Tag比较，相等且V＝1时命中。

- 比较方案：

  ①1个比较器，分时比较(T比较＝G·Δt)；

  **②G个比较器，同时比较(T比较＝Δt)。**

特征：块调入时冲突率**最低**，地址变换速度**较快**，但成本**最高**。

优点：映射灵活，允许主存中的每一个字块映射到Cache的任何一个字块位置上，可**充分利用**Cache 的存储空间。

缺点：成本高，访问Cache时，需要和Cache的全部标记进行“比较”才能判断出所访主存地址的内 容是否已在Cache中，几乎无法实现。



#### 组相联映射

映射规则：将Cache行分组，每组有n行；主存块i可放到Cache中某个组j的任意行，j＝i mod G/n。

实现：把主存分成若干个群，每个群与Cache的一个分组大小相同。

- 主存地址：<群号，群内块号，块内地址>。
- Cache地址：<组号，组内行号，块内地址>。





### 虚拟存储器

### 相联存储器

### 存储保护

### 存储设备