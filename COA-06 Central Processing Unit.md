## CPU概述

### 指令集架构（Instruction Set Architecture）

决定：指令格式、功能，GPRs个数、尾数、编号和功能，存储地址空间、寻址方式、大小端等。

### CPU的功能

- 指令控制：控制指令的**执行顺序**，即执行过程、下条指令地址形成；
- 操作控制：产生指令执行所需的**操作控制信号**；
- 时间控制：控制操作控制信号的**时序**，即时长和次序；
- 数据加工：实现指令约定的**数据运算**，即指令系统定义的运算功能；
- 外部访问：实现对存储器、外设的**访问**；
- 异常及中断处理：实现异常及中断的**检测及处理**。

### CPU的基本功能部件

- 指令控制：PC（程序计数器）、IR（指令寄存器）、ID（指令译码器）
- 操作和时间控制：时序信号、操作控制信号形成电路，即CU（控制器、控制单元）
- 数据运算：ALU（算术逻辑运算部件）、FPU（浮点运算部件）、GPRs（通用寄存器组）、PSR（程序状态寄存器）等
- 外部访问：MAR（存储器地址寄存器）、MDR（存储器数据寄存器）、**BIU（总线接口单元）**、**MMU（存储器管理单元）**
- 中断处理：中断机构

### CPU的寄存器

- 数据寄存器：存放操作数（OPD），长度=机器字长n。

  同时用作源和目的OPD的寄存器，又称为累加寄存器（AC）。

- 地址寄存器：存放OPD地址或指令地址，长度=逻辑地址（或段内地址）位数m。

- 通用寄存器：可用作数据寄存器和地址寄存器，要求长度相同（m=n）。例如：GPRs。

- 状态寄存器：存放程序运行状态，又称标志寄存器。例如：PSR。

  - 结果状态标志：ZF（零）、CF（进位/借位）、SF（负数）、OF（溢出）等，常用作条件码。
  - 执行方式标志：TF（跟踪标志）、IF（中断允许标志）等。

- 专用寄存器：控制CPU的操作和运算。

  - PC：程序计数器，循环变量，用作存放指令地址。
  - IR：存放当前指令内容。
  - MAR：存储器地址寄存器，存放CPU外部访问的部件地址（存储器或外设地址）。
  - MDR：存储器数据寄存器，存放CPU已读出/欲写入的数据。

### CPU的其他功能部件

- 控制单元（CU）：根据指令集架构的定义，形成时序和控制信号。
- 指令译码器（ID）：分析指令的内容（操作码+地址码）。
- 运算器：算术、逻辑运算（ALU），浮点运算（FPU）等。
- 存储器管理单元（MMU）：负责**虚拟地址到物理地址的映射**，并提供硬件机制的内存访问权限检查。
- 中断机构：处理CPU和外设之间的传输以及指令执行过程中发生的如除零、访存缺页等异常。

### CPU基本功能的实现方法

基本步骤：取指令（取指）-> 分析指令（译码）-> 执行指令（执行）à计算指令地址。

特征：所有指令的取指、译码阶段的操作相同；不同指令的执行阶段的操作不同。

### 指令执行过程的特征

组成：执行过程包括取指、译码、执行三个阶段操作。

- 取指阶段：所有指令在取指阶段的操作都相同。

  多字长指令：通常取指仅取首字内容（操作码/寻址方式），执行阶段再取其余内容（地址码）。

- 译码阶段：仅分析指令，无任何具体操作。

- 执行阶段

  - 操作序列受**操作类型、寻址方式、指令字长**的影响；
  - 操作的具体内容是一个包含基本操作的序列。

## 数据通路

### 结构

数据通路：指令执行过程中数据（含指令地址）所经过的部件及其路径

- 功能部件：指令执行过程中用来操作或保存数据的部件。
- 互连结构：部件按照一定方式连接起来，也称为数据通路结构；
  总线结构和点点结构。

### 数据通路功能部件

部件类型：操作部件（加工数据，组合逻辑电路）和状态部件（保存数据，时序逻辑电路）。

部件的常见设置：满足指令执行过程、指令约定功能的需求。

- 取指阶段：PC、IR、Adder（加法器）、MAR、MDR、IMEM（指令MEM/缓存）等。
- 译码阶段：ID（**指令译码器，不属于数据通路**）。
- 执行阶段：GPRs、ALU、PSR、ExtU、DMEM（数据MEM/缓存）等。

### 数据通路的互连结构（总线结构）

基本结构：多个部件的输出端通过**同一信号线**连接其他部件的输入端。

结构分类（根据总线的数量）：单总线、双总线和三总线等。

连接方法：主要关注与总线连接的输入端/输出端。

- 输入端：增设锁存器（实现分时接收）或总线（实现无冲突接收），使每个操作直连总线的**未锁存信号≤1个**，确保端口间信号无干扰。
- 输出端：增设**三态门**，使**同时**发送到总线的**信号≤1个**，确保总线上的信号无冲突。

数据传送的特性：同时只能传送一个数据。

> GPRs地址引脚为什么设置多路选择器MUX？

### 数据通路的互连结构（点点结构）

基本结构：每个输入端通过不同信号线连接其他部件输出端。

连接方法：输出端直连，输入端增设多路选择器。

数据传送的特性：同时可传送多个数据。

### 微操作和微命令

微操作：CPU内部不可再分的原子操作，记为μOP。

- 本质：软件语言到硬件操作的分解。
- 特性：为原子操作，一条机器指令会分为若干个微操作才完成。
- 组成：4种基本操作、特殊操作（PC增量、置位/复位等）。

微命令（指令）：控制部件向执行部件发出的各种控制信号，记为μOPCmd。

- 本质：属于数字电路操作范畴，硬件内部的控制信号。
- 特性：通常由多个μOPCmd组合完成某个μOP。

微程序：实现一条机器指令功能的若干条微指令序列。

## 控制器

功能：全机的指挥中枢，根据程序的指令序列、外部请求、控制台操作去指挥和协调全机的工作。

## 异常和中断

事件：改变程序正常执行顺序的特殊情况。

- 特性1：CPU必须处理；
- 特性2：改变程序约定的顺序（转移型指令属于约定顺序）。

事件分类：（采用Intel定义方式）根据发生的位置。

- 异常（Exception）：CPU内部执行指令所引起的意外事件；（内中断）
- 中断（Interruption）：CPU外部的设备产生的请求事件。（外中断）