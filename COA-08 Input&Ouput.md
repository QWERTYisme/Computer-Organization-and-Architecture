## 输入输出系统

### 输入输出（I/O）设备

#### 输入设备

定义：主要完成输入程序、数据和操作命令等功能的终端设备。

- 字符：键盘
- 图形、图像：鼠标、图形版、触摸屏、扫描仪、摄像头、二维码等
- 语音：麦克风

##### 键盘

功能：由一组排列成阵列形式的按键开关组成，每按下一个键，产生一个相应的字符代码，然后将它转换成ASCII码或其它码，送给主机。

##### 鼠标

功能：利用本身的**平面移动**来控制屏幕上的**光标移动**。

##### 触摸屏

功能：一种可接收触头等输入信号的感应式液晶显示装置，当接触了屏幕上的图形按钮时，屏幕上的**触觉反馈系统**可根据预先编程的程序驱动各种连接装置，并由液晶显示画面输出影音效果。

分类：**电阻式**、**电容式**、**红外线式**、**表面声波**和**底座式矢量压力测力**。

##### 摄像头

功能：通过摄像头摄取景物，经数字化后变成数字图像存入存储设备中。

##### 条形码

功能：将宽度不等的多个黑条和空白，按照一定的**编码**规则排列，用以表达一组**信息**的图形标识符。

分类：**线性条形码（一维条码）**、**矩阵条形码（二维码）**。

#### 输出设备

- **定义：**用于接受计算机数据，输出显示、打印、声音、控制外围设备等操作的终端设备。
- 图形、图像：显示器、打印机、绘图仪等。
- 语音：音箱、耳机。

##### 显示器

功能：将字符、图形、图像的**数字编码**转换为**光学信号**的显示设备。

分类：**阴极射线管（CRT）**、**平板显示器**（含液晶、等离子、场发射和电致发光显示器）

相关术语：

- 像素：图像中的一个最小单位（一个小方格，其状态可编码为一个数字序列）。

- 分辨率：显示屏能表示的像素个数。
- 灰度级：所显示像素点的亮暗差别。
- 刷新率：不断地重复扫描屏幕的刷新频率。
- 亮度：单位坎德拉每平方米（cd/m2）。
- 对比度：显示器画面上最大亮度和最小亮度的比值。

##### 打印机

功能：将信息的**数字编码**转换为字符、图形、图像等，并**打印**在纸上实现信息长期保存。

分类：**点阵针式打印机**、**激光打印机**、**喷墨打印机**、**热转印打印机**。

#### 汉字处理技术

输入：键盘、语音、手写、印刷体扫描识别。

存储：字、形分开存储。

内码：用于汉字信息的存储、交换和检索等的机内代码，一般用两个字节表示一个汉字。

字形码：用点阵表示汉字的输出形式，供显示器或打印机成像使用，一般用16×16等点阵。

输出：根据内码检索字形码输出到显示设备上。

### 输入输出（I/O）系统

#### 输入输出系统

任务：实现**外部设备**（输入输出设备和辅助存储器）与**主机**（CPU和主存）之间的信息交换，即I/O。

组成：**外部设备**和**控制部件**。从软硬件角度又可分为：

- 硬件：外设、I/O接口、总线、传送控制部件。
- 软件：实现I/O的传送控制（**何时传、如何传**）。

连接方式：有**分散连接**和**总线连接**两种。目前全部采用总线连接方式，需通过I/O接口连接。

性能：响应时间、吞吐率，I/O所占CPU时间（开销）。

#### 设备编址

任务：为了实现对I/O设备的寻址和选择，必须给每台设备规定地址码，称为设备代码。

方法：

- 统一编址：主存单元、I/O端口共用一个地址空间。

  CPU直接利用**访存指令**访问I/O端口

  【例】 `MOV AX， [1000] //1000可能为内存地址，也可能为I/O地址`

- 独立编址：主存单元、I/O端口都从零开始编址。 

  CPU需采用**专用指令**访问I/O设备

  【例】设置指令IN/OUT分别完成I/O的输入/输出操作，则下面汇编指令的含义为：

  `MOV AX,   [1000] //访问内存、1000为内存地址`

  `IN  AX,   [1000] //访问I/O设备、1000为I/O地址`

应用：ARM处理器采用统一编址、Intel处理器采用独立编址。 

#### 设备识别方法

需求：I/O接口应**主动识别**是否为操作的**目标从设备**。

操作对象：I/O设备、I/O端口（可与数据总线交换信息的寄存器）。

I/O端口地址的组成

- 外设链接：每个外设分配一个设备号、连接一个I/O接口（外设:I/O接口:I/O端口＝1:1:n ）。
- I/O接口的标识：通过所保存的设备号。
- I/O端口地址：<设备号，内部序号>。

设备选择电路：**监视**总线状态， **有I/O事务**时，**比较**总线上地址与所存设备号。

#### 联络方式

无条件传送方式：可**随时**进行数据传送，又称**同步传送方式。**

- 适用设备：简单设备，**都**为字符设备、并行设备。
- 联络方式：立即响应方式，无需联络信号线。

条件传送方式：先启动设备，等到设备**就绪时**，才能进行传送，又称**异步传送方式**。

- 适用设备：复杂设备，**可**为字符设备或块设备、并/串设备。

- 联络方式：指传送时数据间的定时方式。
  - 异步联络方式：设置请求/应答线，串行传输时**都**缺省。
  - 同步联络方式：设置时钟线，串行传输时**常**缺省。

#### I/O接口的功能

任务：主机-外设之间的连接电路，负责中转**数据/命令/状态**信息。

基本功能：

- 数据缓冲：用寄存器暂存来自主机或外设的**数据**。
- 操作中转：用寄存器暂存主机的**操作命令**，并适时**转发**。
- 状态监测：监视外设**工作状态**，并暂存到寄存器中。
- 通信控制：实现与主机、与外设的**通信**。
- 信号转换：实现主机-外设间的**信号转换**（含格式/电平/时序等）。

#### I/O接口的组成

组成：总线缓冲器、I/O端口、设备选择、控制逻辑等。

信息传送过程：分为主机-I/O端口操作（按总线标准）和I/O端口-外设操作（按设备传输协议）。

#### I/O接口的分类

按数据的传送方式分类：

- 并行接口：接口-外设之间同时传送**n位**数据。
- 接口-外设之间同时传送**1位**数据。

按功能的选择方式分类：

- 可编程接口：可**通过软件**选择接口的当前功能。
- 不可编程接口：须**通过硬连线**选择接口的当前功能。

按传送的控制方式分类（前三种方式是字、块传输的基础）

- 程序直接控制方式：**CPU**控制数据传送、状态查询。
- 程序中断传送方式：**CPU**控制数据传送、**I/O接口**实现状态报告。
- 直接存储器存取（DMA）方式：**I/O接口**控制数据传送、结束后**报告CPU**。
- I/O通道控制方式：在CPU和I/O接口之间增加I/O通道，**辅助**CPU管理控制外部设备。
- 外围处理机方式：**独立**于主机工作，可完成更完整的I/O操作。

以上传送控制方式从上到下**逐步解放CPU**。

#### I/O的传送控制（程序直接控制I/O⽅式）

基本原理：I/O完全**依靠程序**实现，又称程序控制I/O方式。

实现：CPU执行指令，在CPU-外设间、1个数据/次（适用于字符设备）。

分类：

- 程序查询方式：条件传送方式，又称为**轮询**（Polling）方式。
  - 传送控制原理：CPU启动设备后，不断地查询设备状态，当设备就绪时才进行数据传送。
  - I/O所占CPU时间：m个指令周期（从启动到传送的时延）/**数据**，CPU与外设串行工作。
- 直接传送方式：无条件传送方式。
  - 传送控制原理：CPU可随时进行数据传送，无需启动及查询。
  - I/O所占CPU时间：1个指令周期/**数据**。

#### I/O的传送控制（程序中断I/O⽅式）

基本原理：

1. CPU**启动**设备后，继续执行现行程序；
2. 设备准备**就绪**时，向CPU**提出**请求；
3. CPU**响应**请求，**传送**数据，**返回**现行程序。

实现：CPU执行指令，在CPU-外设间、1个数据/次（适用于字符设备）。

I/O所占CPU时间：k个指令周期（＝(响应＋中断服务程序)时延）/**数据**，CPU与外设**可并行**工作。

#### I/O的传送控制（DMA⽅式）

基本原理：

1. CPU**发送**传输需求，**启动**设备后，继续**执行**现行程序；
2. DMA接口**实现**数据传送（1批），结束时向CPU**提出**请求；
3. CPU**响应**请求，**处理**结束事宜，**返回**现行程序。

实现：DMA接口进行总线操作，在外设-主存间、1批数据/次（适用于块设备）。

I/O所占CPU时间：n个指令周期（＝(传送准备＋结束处理＋响应)时延）/**批数据**，CPU与外设**可并行**工作。

### 程序直接控制I/O方式

#### 程序查询方式的I/O控制流程

基本思想：

- CPU**启动**外设后，不断地**查询**外设状态；

- 当外设准备**就绪**时，才进行数据**传送**。

I/O控制流程：用I/O指令实现所有操作。

I/O所占CPU时间：开始查询→完成数据传送的所有时间。

程序查询方式的种类：

- 独占查询：启动设备后，**立即**开始查询状态、直到就绪。 常用于启动时间较**短**的外设I/O。
- 定时查询：启动设备后，**稍后**开始查询状态、直到就绪。 常用于启动时间较**长**的外设I/O。

#### 程序查询方式的I/O接口组织

I/O接口的组成：须设置**状态口**，含就绪位（或忙位）；条件传送方式还需设置**控制口**，含启动位。

工作过程：包括3种独立操作

- 启动设备操作：**完成**总线事务、**发送**命令到外设。
- 查询状态操作：**完成**总线事务（状态一直在检测）。
- 传送数据操作：**完成**总线事务、**发送**数据到外设。

#### 直接传送方式的I/O接口组织

I/O控制流程：CPU可**随时**进行数据传送，**无需**启动及查询。

I/O接口的组织：只有**数据口**，必是并行接口（串行均为条件传送）。

工作过程：只有1种操作

- 传送数据操作：**完成**总线事务、**发送/接收**数据到外设。

例题？

### 程序中断I/O方式

#### 程序中断方式的I/O控制流程

基本思想：

- CPU**启动**设备后，继续**执行**现行程序；
- 设备准备**就绪**时，向CPU**提出**请求；
- CPU**响应**请求，**传送**数据，**返回**现行程序。

I/O控制流程：中断**响应**->中断**处理**->中断**返回**（**响应**由硬件实现，**处理及返回**由软件实现）。

I/O所占CPU时间：响应时延＋中断程序执行时间。

#### 中断的类型

可屏蔽中断与不可屏蔽中断：基于请求的紧急程度。

- 可屏蔽中断MI：请求可以**暂不处理**（或稍后处理），例如键盘、打印机等设备的I/O请求。
- 不可屏蔽中断NMI：请求必须**立即处理**，例如电源故障、线路故障、存储校验错等硬件错误。

向量中断与非向量中断：基于响应的实现方法。

- 向量中断：通过软件在中断处理时**识别**事件类型、获得处理程序入口地址。
- 非向量中断：所有事件**共用**一个中断处理程序，不同事件的处理程序以函数形式存在。

单重中断与多重中断：基于处理过程能否重叠。

- 单重中断：中断处理过程中**不再**响应新的中断请求，当前中断处理结束后才能处理其他中断请求。
- 多重中断：中断处理过程中**可以**响应新的中断请求，暂停当前处理并转向执行新请求的中断程序。

#### 中断接口的组织

功能：基于查询接口，可产生/撤销中断请求、提供中断类型号(可无)。

I/O接口的组织：除常规部件，增设中断请求位INT、允许位EI，以及请求产生/撤销、中断响应电路。

工作过程：与**程序直接控制I/O方式**基本相同，不同之处在于：

- 中断请求产生：**触发**于启动设备操作，EI＝1、RD从0→1时。
- 中断响应操作：**响应**总线事务、**撤销**中断请求。
- 中断请求撤销：**触发**于**中断响应操作**或**读状态口**(非向量中断)。

#### 识别中断源（中断排队、中断判优）

任务：**选出**最紧急请求，**获得**其中断类型号（系统为中断源分配的唯一代码）、**撤销**该请求。

- 选出请求：与请求的连接方式有关。
-  获得类型号：与向量/非向量中断方式有关。

中断请求的连接方式

- 共用请求式：各中断源**共用**请求线。
- 独立请求式：各中断源请求线**独立**。

#### 中断源的判优方法

软件判优：适于共用/独立请求式连接、非向量中断。

- 判优原理：软件查询，查询次序→优先级(静态)。
- 获得类型号的方法：**无需**获得，用CALL指令直接转入。
- I/O接口的需求：**无需**响应电路，读状态口时撤销请求。

串行判优：适于共用请求式连接、向量中断。

- 判优原理：硬件自动轮询，查询次序→优先级(静态)。
- 获得类型号的方法：**中断源**给出。
- I/O接口的需求：需响应电路，**中断响应**时撤销请求。

并行判优：适于独立请求式连接、向量中断。

- 判优原理：硬件算法控制，算法→优先级(动态)。
- 获得类型号的方法：**中断机构**产生(常按请求连接次序)。
- I/O接口的需求：**无需**响应电路，**I/O操作时**撤销请求。

#### 中断控制器（Interrupt Controller）

本质：并行判优部件＋中断源 → 介于CPU和I/O接口之间。

基本功能：

1. **检测并记录**中断请求、向CPU**提出**中断请求。
2. **处理**中断响应操作(**提供**中断类型号、**复位**所选请求)。
3. **管理**处理过程中的请求(中断结束前**阻塞**低级请求) 。
4. **处理**I/O操作(如设置工作方式、修改优先级)

#### 多重中断处理

含义：中断处理过程中可以响应新的中断请求，新中断请求应比正在处理的中断请求优先级更高。

新请求检测：以中断控制器为例

- 中断请求的状态：正在服务（IS）、尚未服务（IR）。
- 新请求的产生条件：max(IRi优先级)＞max(ISj优先级)。
- 检测机构的组成：增设中断服务寄存器ISR、排队器(分类排队)。

保存部件的组织：用**后援寄存器**栈代替后援寄存器堆。

#### 中断系统（以向量中断方式为例）

基本组成

- 硬件：中断结构、I/O接口、中断控制器。
- IVT、各个中断处理程序。

### 直接存储器存期（DMA）I/O方式

#### 以“主存”为中心的硬件结构

目标：数据处理与数据传送（I/O）并行。

机制

- 数据传送无需CPU实现。
- 传送期间CPU可正常执行程序。

方案：外设-主存之间**直接**传送数据。

#### DMA方式

I/O的功能：主存-外设间、传送1批数据/次。

I/O对CPU的要求

- 负责传送准备及结束处理工作：如设置传送字数（批量）、主存首址、启动设备。
- 数据传送时让出总线使用权：DMA接口此时为主设备（平时为从设备）。

特征：传送不占CPU时间，传送速率为1个数据/总线周期。

I/O传送控制流程：**传送准备**、**结束处理**由软件实现，**数据传送**由硬件实现。

#### DMA的传送方式

含义：指DMA接口获得**总线使用权**的方法（从设备→主设备）。

分类：基于对总线使用权的管理方式

- CPU停止访问方式：DMA使用总线时CPU**暂停**需经过总线的一切访问。
- 周期挪用方式：CPU空闲时**让出**总线控制权给DMA（被动）。
- 总线使用权按**时间片**分配给CPU和DMA交替使用（主动）。

#### DMA的传送方式（CPU停止访问方式）

管理方法：

- DMA接口在**首个数据**准备传送时，**申请**总线使用权；
- DMA接口在**所有数据**传送结束时，**放弃**总线使用权。

特点：控制简单，传输效率高，CPU工作效率低。

应用：适于**外设速度≈主存速度**的场合。

#### DMA的传送方式（周期挪用方式）

管理方法：

- DMA接口在外设准备**就绪时**，请求总线使用权；
- DMA接口在**等待**外设准备时，放弃总线使用权。

特点：传输效率、CPU工作效率都高，控制略复杂。

应用：适用于**外设速度＜主存速度**的场合。

优先级：DMA请求的优先级应高于CPU请求，防止丢失数据（如磁盘）或工作紊乱。

#### DMA的传送方式（分时交替访问方式）

管理方法：总线使用权**定时地**轮流分配给CPU及DMA接口使用。

特点：无需请求-响应，传输效率、CPU工作效率均高。

应用：适于**CPU访存间隔＞主存周期×2**的场合(**很少使用**) 。

DMA传送方式的常见选择：DMA接口常**支持多种**传送方式，I/O时**选择适当**的传送方式。

#### DMA接口的功能与结构

基本功能：**DMA传送控制**（总线请求和传输、批量管理）＋**设备I/O接口**（常规功能、结束产生请求）。

基本结构：

- 设备I/O接口逻辑：中断式I/O接口。
- DMA传送控制逻辑：MAC及WC、总线控制、DMA控制（含请求）。

#### DMA的传送过程（含预处理、数据传送和后处理）

##### 预处理（DMA初始化）

- 任务：CPU使用I/O指令设置传送参数、启动外设。
- 设置传送参数：设置缓冲区首址、传送字数、传送方向及传送方式等。
- 启动外设：发送操作命令及参数 。

##### 数据传送（DMA传送）

- 任务：DMA接口**循环地**传送数据(一个字/次)，直至传送完毕。
-  申请总线使用权：申请时机与传送方式有关。
- 传送数据：操作命令与传送方向有关。
- 实现循环
  - MAC←(MAC)＋1、WC←(WC)－1
  - 若WC≠0，启动外设(开始下一字)，并转入①；若WC＝0，提出中断请求(已传送完毕)。

##### 后处理

任务：CPU**响应**中断请求，完成结束处理工作(如数据校验、开始下次) 。

#### DMA方式和中断方式的比较

相同点

- 与CPU的联络：都采用请求-响应方式。
- I/O过程：都由软硬件共同完成。

不同点

- **见ppt**

### 总线结构

### 外设接口

